<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≠ch xu·∫•t ƒë∆°n h√†ng</title>
    <?!= include('shared-styles'); ?>
    <style>
        /* Override container width for better desktop experience - FORCE OVERRIDE */
        .container {
            max-width: 95% !important;
            margin: 20px auto !important;
        }
        
        /* Additional overrides for full width experience */
        @media (min-width: 1200px) {
            .container {
                max-width: 95% !important;
                width: 95% !important;
            }
        }
        
        .date-inputs {
            display: flex;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .date-group {
            flex: 1;
            min-width: 200px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.95em; /* Slightly larger base font */
            min-width: 1000px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px 10px; /* Increased padding */
            text-align: left;
            white-space: nowrap;
            font-size: inherit; /* Consistent font size */
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: center;
            font-size: 0.9em; /* Consistent header font */
            padding: 12px 8px;
        }
        
        /* Column specific styles - Balanced and consistent */
        .col-date { 
            width: 100px; 
            text-align: center;
        }
        .col-shop { 
            width: 80px; 
            text-align: center;
            font-weight: 500;
        }
        .col-order-code { 
            width: 150px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.9em;
            background: #f8f9fa;
        }
        .col-short-invoice { 
            width: 100px; 
            font-family: 'Courier New', monospace; 
            font-weight: 600;
            text-align: center;
            background: #e3f2fd;
            color: #1565c0;
        }
        .col-short-tracking { 
            width: 100px; 
            font-family: 'Courier New', monospace;
            text-align: center;
            background: #f3e5f5;
            color: #7b1fa2;
        }
        .col-tracking { 
            width: 180px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.9em; /* Only slightly smaller */
            background: #fafafa;
        }
        .col-carrier { 
            width: 80px; 
            text-align: center;
            font-weight: 500;
        }
        .col-receiver { 
            min-width: 200px; 
            max-width: 350px;
            font-weight: 500;
        }
        .col-checkbox { 
            width: 90px; 
            text-align: center;
            background: #f5f5f5;
        }
        
        /* Row styling */
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        tr.packed {
            background: #e6f7e6 !important;
        }
        
        tr.packed:hover {
            background: #d4edda !important;
        }
        
        /* Enhanced checkbox styling */
        input[type="checkbox"] {
            transform: scale(1.5);
            margin: 8px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        /* Better text wrapping for long content */
        .col-receiver {
            white-space: normal !important;
            word-wrap: break-word;
            max-width: 350px;
        }
        
        /* Hover effects */
        tbody tr:hover {
            background: #e3f2fd !important;
            transform: scale(1.001);
            transition: all 0.2s ease;
        }
        
        tbody tr:hover .col-order-code,
        tbody tr:hover .col-short-invoice,
        tbody tr:hover .col-short-tracking {
            font-weight: 600;
        }
        
        /* Responsive design */
        @media (max-width: 1400px) {
            .container {
                max-width: 98% !important;
            }
        }
        
        @media (max-width: 1200px) {
            .container {
                max-width: 98% !important;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 0.9em; /* Consistent medium screen font */
            }
            
            /* Adjust columns for medium screens */
            .col-order-code { width: 130px; }
            .col-tracking { width: 160px; }
            .col-receiver { min-width: 180px; max-width: 300px; }
        }
        
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 10px;
            }
            
            input[type="checkbox"] {
                transform: scale(1.8);
            }
            
            .date-inputs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 0.85em; /* Still readable on mobile */
            }
            
            /* Hide less important columns on mobile */
            .col-short-tracking,
            .col-tracking {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .col-carrier {
                display: none;
            }
        }
        
        /* Stats row */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stats-card {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 120px;
            flex: 1;
        }
        
        .stats-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stats-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="?" class="navbar-brand">üè¢ H·ªá th·ªëng qu·∫£n l√Ω</a>
        <div class="navbar-nav">
            <a href="?" class="nav-link">üè† Trang ch·ªß</a>
            <a href="?page=extract-orders" class="nav-link">üì¶ ƒê∆°n h√†ng</a>
            <a href="?page=shipping-labels" class="nav-link">üè∑Ô∏è Tem v·∫≠n chuy·ªÉn</a>
            <a href="?page=inventory" class="nav-link">üìä Kho</a>
            <a href="?page=reports" class="nav-link">üìà B√°o c√°o</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">üì¶ Tr√≠ch xu·∫•t ƒë∆°n h√†ng theo ng√†y</h1>
            </div>
            
            <div class="date-inputs">
                <div class="date-group">
                    <label class="form-label">üìÖ T·ª´ ng√†y:</label>
                    <input type="date" id="startDate" class="form-input">
                </div>
                
                <div class="date-group">
                    <label class="form-label">üìÖ ƒê·∫øn ng√†y:</label>
                    <input type="date" id="endDate" class="form-input">
                </div>
            </div>
            
            <div class="action-buttons">
                <button onclick="runExtract()" class="btn">üîç Truy xu·∫•t ƒë∆°n h√†ng</button>
                <button onclick="runUpdate()" class="btn btn-secondary">üíæ C·∫≠p nh·∫≠t ƒë√≥ng g√≥i</button>
                <button onclick="selectAll()" class="btn btn-secondary">‚òëÔ∏è Ch·ªçn t·∫•t c·∫£</button>
                <button onclick="deselectAll()" class="btn btn-secondary">‚òê B·ªè ch·ªçn t·∫•t c·∫£</button>
            </div>
            
            <div id="message"></div>
            
            <!-- Stats row -->
            <div class="stats-row" id="statsRow" style="display: none;">
                <div class="stats-card">
                    <div class="stats-number" id="totalOrders">0</div>
                    <div class="stats-label">T·ªïng ƒë∆°n</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="packedOrders">0</div>
                    <div class="stats-label">ƒê√£ ƒë√≥ng g√≥i</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="unpackedOrders">0</div>
                    <div class="stats-label">Ch∆∞a ƒë√≥ng g√≥i</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="selectedOrders">0</div>
                    <div class="stats-label">ƒêang ch·ªçn</div>
                </div>
            </div>
            
            <div class="table-container">
                <div id="output"></div>
            </div>
        </div>
    </div>

    <script>
        // Set default dates to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("startDate").value = today;
        document.getElementById("endDate").value = today;

        let currentData = [];

        function showMessage(text, type = 'loading') {
            const messageDiv = document.getElementById("message");
            messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function updateStats() {
            const checkboxes = document.querySelectorAll("input[type=checkbox][data-row]");
            const total = checkboxes.length;
            const packed = document.querySelectorAll("tr.packed").length;
            const unpacked = total - packed;
            const selected = document.querySelectorAll("input[type=checkbox][data-row]:checked").length;

            document.getElementById("totalOrders").textContent = total;
            document.getElementById("packedOrders").textContent = packed;
            document.getElementById("unpackedOrders").textContent = unpacked;
            document.getElementById("selectedOrders").textContent = selected;

            if (total > 0) {
                document.getElementById("statsRow").style.display = "flex";
            }
        }

        function runExtract() {
            const start = document.getElementById("startDate").value;
            const end = document.getElementById("endDate").value;

            if (!start || !end) {
                showMessage("‚ùå Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c", 'error');
                return;
            }

            showMessage("‚è≥ ƒêang truy xu·∫•t d·ªØ li·ªáu...", 'loading');
            document.getElementById("output").innerHTML = "";
            document.getElementById("statsRow").style.display = "none";

            google.script.run
                .withSuccessHandler(function(result) {
                    showMessage(result.message, result.success ? 'success' : 'error');
                    document.getElementById("output").innerHTML = "";
                    
                    if (result.success && result.rows.length) {
                        currentData = result;
                        renderTable(result);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage("‚ùå L·ªói: " + error.message, 'error');
                })
                .extractByDateRange(start, end);
        }

        function renderTable(result) {
            const table = document.createElement("table");

            // Create header row
            const headerRow = document.createElement("tr");
            
            // Define columns with their classes
            const columns = [
                { text: "Ng√†y", class: "col-date" },
                { text: "Shop", class: "col-shop" },
                { text: "M√£ ƒë∆°n", class: "col-order-code" },
                { text: "Short Invoice", class: "col-short-invoice" },
                { text: "ƒê√£ ƒë√≥ng g√≥i", class: "col-checkbox" },
                { text: "Short Tracking", class: "col-short-tracking" },
                { text: "Tracking", class: "col-tracking" },
                { text: "Carrier", class: "col-carrier" },
                { text: "Ng∆∞·ªùi nh·∫≠n", class: "col-receiver" }
            ];

            columns.forEach(col => {
                const th = document.createElement("th");
                th.innerText = col.text;
                th.className = col.class;
                headerRow.appendChild(th);
            });
            
            table.appendChild(headerRow);

            // Create data rows
            result.rows.forEach((row, idx) => {
                const tr = document.createElement("tr");
                const packedState = row[8];  // Last element is packed status

                // Set packed class if already packed
                if (packedState) {
                    tr.classList.add('packed');
                }

                // Add data columns
                for (let j = 0; j < 4; j++) { // Date, Shop, Order Code, Short Invoice
                    const td = document.createElement("td");
                    td.innerText = row[j];
                    td.className = columns[j].class;
                    tr.appendChild(td);
                }

                // Add checkbox column (index 4)
                const tdChk = document.createElement("td");
                tdChk.className = columns[4].class;
                
                const chk = document.createElement("input");
                chk.type = "checkbox";
                chk.dataset.row = idx;
                chk.checked = packedState;
                chk.addEventListener('change', updateRowStyle);
                
                tdChk.appendChild(chk);
                tr.appendChild(tdChk);

                // Add remaining columns (Short Tracking, Tracking, Carrier, Receiver)
                for (let j = 4; j < 8; j++) {
                    const td = document.createElement("td");
                    td.innerText = row[j];
                    td.className = columns[j + 1].class;
                    tr.appendChild(td);
                }

                table.appendChild(tr);
            });

            document.getElementById("output").appendChild(table);
            updateStats();
        }

        function updateRowStyle(event) {
            const checkbox = event.target;
            const row = checkbox.closest('tr');
            
            if (checkbox.checked) {
                row.classList.add('packed');
            } else {
                row.classList.remove('packed');
            }
            
            updateStats();
        }

        function runUpdate() {
            const start = document.getElementById("startDate").value;
            const end = document.getElementById("endDate").value;
            
            if (!start || !end) {
                showMessage("‚ùå Vui l√≤ng ch·ªçn ng√†y tr∆∞·ªõc khi c·∫≠p nh·∫≠t", 'error');
                return;
            }

            // Get all checked checkboxes
            const picked = Array.from(document.querySelectorAll("input[type=checkbox][data-row]"))
                .filter(c => c.checked)
                .map(c => parseInt(c.dataset.row, 10));

            showMessage("‚è≥ ƒêang c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√≥ng g√≥i...", 'loading');
            
            google.script.run
                .withSuccessHandler(function(res) {
                    showMessage(res.message, res.success ? 'success' : 'error');
                    // Auto refresh data after update
                    if (res.success) {
                        setTimeout(() => runExtract(), 1000);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage("‚ùå L·ªói c·∫≠p nh·∫≠t: " + error.message, 'error');
                })
                .updatePackedStatus(start, end, picked);
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll("input[type=checkbox][data-row]");
            checkboxes.forEach(cb => {
                cb.checked = true;
                updateRowStyle({target: cb});
            });
            showMessage("‚úÖ ƒê√£ ch·ªçn t·∫•t c·∫£ ƒë∆°n h√†ng", 'success');
        }

        function deselectAll() {
            const checkboxes = document.querySelectorAll("input[type=checkbox][data-row]");
            checkboxes.forEach(cb => {
                cb.checked = false;
                updateRowStyle({target: cb});
            });
            showMessage("‚úÖ ƒê√£ b·ªè ch·ªçn t·∫•t c·∫£ ƒë∆°n h√†ng", 'success');
        }

        // Auto-load today's data when page loads
        window.onload = function() {
            showMessage("üöÄ S·∫µn s√†ng truy xu·∫•t ƒë∆°n h√†ng. Click 'Truy xu·∫•t' ƒë·ªÉ b·∫Øt ƒë·∫ßu.", 'success');
            
            // Debug: Check container width
            const container = document.querySelector('.container');
            console.log('Container width:', window.getComputedStyle(container).width);
            console.log('Window width:', window.innerWidth);
            
            // Force container width for desktop
            if (window.innerWidth > 1200) {
                container.style.maxWidth = '95%';
                container.style.width = '95%';
                console.log('Forced container width to 95%');
            }
        };
    </script>
</body>
</html>