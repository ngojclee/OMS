<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý công việc nhân viên</title>
    
    <!-- Include shared styles for entire project -->
    <?!= include('shared-styles'); ?>
    
    <!-- Page-specific styles -->
    <style>
        /* ===================================================================
           EMPLOYEE TASKS - PAGE SPECIFIC STYLES
           ================================================================== */
        
        .controls-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .controls-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .controls-row:last-child {
            margin-bottom: 0;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-label {
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .form-input, .form-select {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: white;
            color: #333;
            min-width: 150px;
        }
        
        .btn-panel {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-panel:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .btn-primary {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: transparent;
        }
        
        .btn-success {
            background: rgba(40,167,69,0.9);
            border-color: rgba(40,167,69,1);
        }
        
        .btn-danger {
            background: rgba(220,53,69,0.9);
            border-color: rgba(220,53,69,1);
        }
        
        /* Task Cards */
        .tasks-container {
            display: grid;
            gap: 20px;
        }
        
        .task-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .task-card.overdue {
            border-left: 5px solid #dc3545;
        }
        
        .task-card.completed {
            opacity: 0.8;
            border-left: 5px solid #28a745;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .task-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .task-checkbox {
            transform: scale(1.5);
            cursor: pointer;
        }
        
        .task-title-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .task-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .task-title {
            font-size: 1em;
            font-weight: 500;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            flex: 1;
        }
        
        .task-subtitle {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .working-code-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            font-family: monospace;
        }
        
        .task-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Badge Styles */
        .employee-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .task-shop-badge {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .task-sku-badge {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            font-family: monospace;
        }
        
        .task-sku-empty {
            background: #ffebee;
            color: #c62828;
        }
        
        .task-ref-badge {
            background: #fff3e0;
            color: #ef6c00;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .task-deadline {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .task-deadline.normal {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .task-deadline.urgent {
            background: #ffebee;
            color: #c62828;
            animation: urgentBlink 1s infinite;
        }
        
        @keyframes urgentBlink {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Task Body */
        .task-body {
            display: grid;
            grid-template-columns: 1fr 300px 300px;
            gap: 20px;
            padding: 20px 25px;
            align-items: start;
        }
        
        .task-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .working-code {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .info-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
            min-width: 80px;
        }
        
        .info-value {
            color: #333;
        }
        
        .description {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            line-height: 1.5;
            color: #555;
        }
        
        /* Images */
        .image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .product-image, .result-image {
            width: 100%;
            max-width: 280px;
            height: 280px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .product-image:hover, .result-image:hover {
            transform: scale(1.02);
        }
        
        .image-placeholder {
            width: 100%;
            max-width: 280px;
            height: 280px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #666;
            text-align: center;
        }
        
        .product-image-container {
            position: relative;
            display: inline-block;
        }
        
        .product-sku-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 4px;
            display: inline-block;
        }
        
        .image-source-badge {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            font-weight: 500;
            margin-top: 2px;
            display: inline-block;
        }
        
        /* Buttons */
        .btn-upload, .btn-upload-small {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-upload:hover, .btn-upload-small:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-upload-small {
            font-size: 0.75em;
            padding: 4px 8px;
        }
        
        .btn-copy-task {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-copy-task:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(255,152,0,0.3);
        }
        
        /* Status */
        .task-done {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .done-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .done-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .task-status {
            display: flex;
            gap: 10px;
        }
        
        .status-delivery, .status-completion {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-delivered {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Stats */
        .stats-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 140px;
            flex: 1;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .message.loading {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }
        
        .message.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        
        .message.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .message.warning {
            background: #fff8e1;
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }
        
        .message.info {
            background: #f3e5f5;
            color: #7b1fa2;
            border-left: 4px solid #9c27b0;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .empty-state p {
            margin: 5px 0;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .task-body {
                grid-template-columns: 1fr 250px 250px;
            }
            
            .product-image, .result-image, .image-placeholder {
                max-width: 230px;
                height: 230px;
            }
        }
        
        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .form-input, .form-select {
                min-width: auto;
                width: 100%;
            }
            
            .task-body {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .task-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .task-right {
                width: 100%;
                justify-content: flex-start;
            }
            
            .product-image, .result-image, .image-placeholder {
                max-width: 100%;
                height: 200px;
            }
            
            .stats-summary {
                gap: 15px;
            }
            
            .stat-item {
                min-width: auto;
            }
        }
        
        @media (max-width: 480px) {
            .controls-panel {
                padding: 20px;
            }
            
            .task-card {
                margin: 0 -10px;
            }
            
            .task-header {
                padding: 15px 20px 10px;
            }
            
            .task-body {
                padding: 15px 20px;
            }
            
            .btn-panel {
                padding: 8px 16px;
                font-size: 0.9em;
            }
            
            .stats-summary {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="?" class="navbar-brand">🏢 Hệ thống quản lý</a>
        <div class="navbar-nav">
            <a href="?" class="nav-link">🏠 Trang chủ</a>
            <a href="?page=extract-orders" class="nav-link">📦 Đơn hàng</a>
            <a href="?page=shipping-labels" class="nav-link">🏷️ Tem vận chuyển</a>
            <a href="?page=employee-tasks" class="nav-link active">👥 Giao việc</a>
            <a href="?page=inventory" class="nav-link">📊 Kho</a>
            <a href="?page=products-integration" class="nav-link">🛍️ Sản phẩm</a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <div class="card">
            <!-- Page Header -->
            <div class="card-header">
                <h1 class="card-title">👥 Quản lý công việc nhân viên</h1>
                <p class="card-subtitle">Fetch, quản lý và cập nhật tasks từ employee sheets với product data integration</p>
            </div>
            
            <!-- Controls Panel -->
            <div class="controls-panel">
                <!-- Employee and Date Selection -->
                <div class="controls-row">
                    <div class="control-group">
                        <label class="control-label">👤 Nhân viên:</label>
                        <select id="employeeSelector" class="form-select">
                            <option value="">Đang tải...</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">📅 Từ ngày:</label>
                        <input type="date" id="startDate" class="form-input">
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">📅 Đến ngày:</label>
                        <input type="date" id="endDate" class="form-input">
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="controls-row">
                    <div class="control-group">
                        <label class="control-label">📋 Tình trạng giao task:</label>
                        <div style="display: flex; gap: 15px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="deliveryFilter" value="pending" checked>
                                <span>Chưa giao task</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="deliveryFilter" value="delivered">
                                <span>Đã giao task</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="deliveryFilter" value="all">
                                <span>Tất cả</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">✅ Tình trạng hoàn thành:</label>
                        <div style="display: flex; gap: 15px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="completionFilter" value="pending" checked>
                                <span>Chưa xong</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="completionFilter" value="completed">
                                <span>Đã xong</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="completionFilter" value="all">
                                <span>Tất cả</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="controls-row">
                    <button onclick="fetchTasks()" class="btn-panel btn-primary">🔍 Fetch Tasks</button>
                    <button onclick="confirmDelivery()" class="btn-panel btn-success">📤 Xác nhận giao đơn</button>
                    <button onclick="markCompleted()" class="btn-panel btn-success">✅ Đánh dấu hoàn thành</button>
                    <button onclick="markIncomplete()" class="btn-panel btn-danger">❌ Bỏ hoàn thành</button>
                    <button onclick="runDebug()" class="btn-panel" style="background: rgba(255,165,0,0.9);">🔧 Debug System</button>
                    <button onclick="testConnectivity()" class="btn-panel" style="background: rgba(0,123,255,0.9);">🔗 Test Connectivity</button>
                    <button onclick="window.testSystemComponents ? testSystemComponents() : alert('Function not loaded yet!')" class="btn-panel" style="background: rgba(156,39,176,0.9);">🧪 Test Components</button>
                    <button onclick="forceSetDatesAndLoadEmployees()" class="btn-panel" style="background: rgba(76,175,80,0.9);">🔄 Force Reload</button>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="statusMessage"></div>
            
            <!-- Stats Summary -->
            <div class="stats-summary" id="statsSummary" style="display: none;">
                <div class="stat-item">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Tổng task</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pendingDelivery">0</div>
                    <div class="stat-label">Chưa giao</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pendingCompletion">0</div>
                    <div class="stat-label">Chưa xong</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="overdueTasks">0</div>
                    <div class="stat-label">Quá hạn</div>
                </div>
            </div>
            
            <!-- Tasks Container -->
            <div class="tasks-container" id="tasksContainer">
                <div class="empty-state">
                    <h3>📋 Chọn nhân viên và fetch tasks</h3>
                    <p>Sử dụng form trên để fetch tasks với product data từ Mr Ngoc Products sheet</p>
                    <p style="font-size: 0.9em; color: #999; margin-top: 15px;">
                        💡 Hệ thống tự động tải SKU và hình ảnh sản phẩm khi fetch tasks
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Page JavaScript -->
    <script>
        let currentTasks = [];
        
        // ===================================================================
        // CORE UTILITY FUNCTIONS
        // ===================================================================
        
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="message ' + type + '">' + message + '</div>';
            }
            console.log('[' + type.toUpperCase() + '] ' + message);
            
            // Auto-hide non-loading messages
            if (type !== 'loading') {
                setTimeout(() => {
                    if (statusDiv) statusDiv.innerHTML = '';
                }, 5000);
            }
        }
        
        function formatDateForDisplay(date) {
            return date.toLocaleDateString('vi-VN');
        }
        
        // ===================================================================
        // EMPLOYEE AND DATE MANAGEMENT
        // ===================================================================
        
        function forceSetDatesAndLoadEmployees() {
            console.log('🔄 Force reloading dates and employees...');
            showStatus('🔄 Force reloading...', 'loading');
            
            // Force set dates
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            const startDateEl = document.getElementById('startDate');
            const endDateEl = document.getElementById('endDate');
            
            if (startDateEl) startDateEl.value = todayStr;
            if (endDateEl) endDateEl.value = todayStr;
            
            console.log('✅ Force set dates to: ' + todayStr);
            showStatus('📅 Ngày: ' + todayStr, 'info');
            
            // Force load employees
            loadEmployees();
        }
        
        function loadEmployees() {
            const selector = document.getElementById('employeeSelector');
            if (!selector) {
                showStatus('❌ Không tìm thấy employee selector!', 'error');
                return;
            }
            
            selector.innerHTML = '<option value="">Đang tải...</option>';
            
            // Add All option
            const allOption = document.createElement('option');
            allOption.value = 'All';
            allOption.textContent = '👥 Tất cả nhân viên';
            selector.appendChild(allOption);
            
            // Try backend first
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler(handleEmployeeLoadSuccess)
                    .withFailureHandler(handleEmployeeLoadError)
                    .getEmployeeListFromSettings();
            } else {
                console.warn('⚠️ Google Apps Script not available');
                loadHardcodedEmployees(selector);
            }
        }
        
        function handleEmployeeLoadSuccess(result) {
            console.log('✅ Backend result:', result);
            
            const selector = document.getElementById('employeeSelector');
            selector.innerHTML = '<option value="">Chọn nhân viên...</option>';
            
            // Re-add All option
            const allOption = document.createElement('option');
            allOption.value = 'All';
            allOption.textContent = '👥 Tất cả nhân viên';
            selector.appendChild(allOption);
            
            if (result && result.success && result.data && result.data.length > 0) {
                result.data.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.name || emp;
                    option.textContent = emp.name ? 
                        emp.name + ' (' + (emp.role || 'N/A') + ')' : emp;
                    selector.appendChild(option);
                });
                showStatus('✅ Tải ' + result.data.length + ' nhân viên từ Settings', 'success');
            } else {
                loadHardcodedEmployees(selector);
            }
        }
        
        function handleEmployeeLoadError(error) {
            console.error('❌ Backend failed:', error);
            const selector = document.getElementById('employeeSelector');
            loadHardcodedEmployees(selector);
        }
        
        function loadHardcodedEmployees(selector) {
            console.log('🔄 Loading hardcoded employees...');
            
            // Clear and add All
            selector.innerHTML = '<option value="">Chọn nhân viên...</option>';
            const allOption = document.createElement('option');
            allOption.value = 'All';
            allOption.textContent = '👥 Tất cả nhân viên';
            selector.appendChild(allOption);
            
            // Add hardcoded employees
            const employees = ['My Nguyen', 'Tuyen Phan', 'Tun Nail'];
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp;
                option.textContent = emp;
                selector.appendChild(option);
            });
            
            showStatus('✅ Sử dụng danh sách nhân viên mặc định', 'warning');
        }
        
        // ===================================================================
        // TASK MANAGEMENT
        // ===================================================================
        
        function fetchTasks() {
            const employeeName = document.getElementById('employeeSelector').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!employeeName) {
                showStatus('❌ Vui lòng chọn nhân viên!', 'error');
                return;
            }
            
            if (!startDate || !endDate) {
                showStatus('❌ Vui lòng chọn khoảng thời gian!', 'error');
                return;
            }
            
            const filters = getFilters();
            
            showStatus('🔄 Đang fetch tasks với product data cho ' + employeeName + '...', 'loading');
            
            google.script.run
                .withSuccessHandler(handleFetchTasksSuccess)
                .withFailureHandler(handleFetchTasksError)
                .getEmployeeTasksWithProducts(employeeName, startDate, endDate, { filters: filters });
        }
        
        function handleFetchTasksSuccess(result) {
            console.log('Enhanced fetch result:', result);
            
            if (result.success) {
                currentTasks = result.data;
                renderTasks(currentTasks);
                updateStats(currentTasks);
                showStatus('✅ Đã tải ' + result.count + ' tasks (' + (result.withProductData || 0) + ' có product data)!', 'success');
            } else {
                showStatus('❌ Lỗi: ' + result.error, 'error');
            }
        }
        
        function handleFetchTasksError(error) {
            console.error('Fetch error:', error);
            showStatus('❌ Không thể fetch: ' + error.message, 'error');
        }
        
        function getFilters() {
            const deliveryFilter = document.querySelector('input[name="deliveryFilter"]:checked').value;
            const completionFilter = document.querySelector('input[name="completionFilter"]:checked').value;
            
            return {
                deliveryStatus: deliveryFilter,
                completionStatus: completionFilter
            };
        }
        
        // ===================================================================
        // TASK RENDERING
        // ===================================================================
        
        function renderTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>📭 Không có task nào</h3>
                        <p>Thử thay đổi bộ lọc hoặc khoảng thời gian</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            tasks.forEach((task, index) => {
                const cardClass = getTaskCardClass(task);
                const productImageHtml = generateProductImageHtml(task);
                const resultImageHtml = generateResultImageHtml(task);
                const statusHtml = generateStatusHtml(task);
                
                html += `
                    <div class="${cardClass}">
                        <div class="task-header">
                            <div class="task-left">
                                <input type="checkbox" class="task-checkbox" data-index="${index}">
                                <div class="task-title-container">
                                    <div class="task-title-row">
                                        <span class="task-title">${task.itemName || 'Task'}</span>
                                        ${task.employeeName ? '<span class="employee-badge">' + task.employeeName + '</span>' : ''}
                                        <span class="working-code-badge">${task.workingCode}</span>
                                    </div>
                                    <div class="task-subtitle">
                                        ${task.shop ? '<div class="task-shop-badge">🏪 ' + task.shop + '</div>' : ''}
                                        ${generateSkuBadge(task)}
                                        ${task.refId ? '<div class="task-ref-badge">🔗 ' + task.refId + '</div>' : ''}
                                        <div class="${getDeadlineClass(task)}">⏰ ${task.deadline}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="task-right">
                                ${statusHtml}
                                <button onclick="exportTaskVisual(${index})" class="btn-copy-task" title="Export task với hình ảnh">📋 Copy đơn</button>
                            </div>
                        </div>
                        
                        <div class="task-body">
                            <div class="task-info">
                                <div class="working-code">#${getCleanWorkingCode(task.workingCode)}</div>
                                
                                <div class="info-row">
                                    <span class="info-label">📅 Date:</span>
                                    <span class="info-value">${task.date}</span>
                                </div>
                                
                                <div class="description">
                                    <strong>📝 Mô tả:</strong><br>
                                    ${task.description || 'Không có mô tả'}
                                </div>
                                
                                ${task.sku ? '<div class="info-row"><span class="info-label">🏷️ SKU Sheet:</span><span class="info-value">' + task.sku + '</span></div>' : ''}
                            </div>
                            
                            <div class="image-container">
                                ${productImageHtml}
                            </div>
                            
                            <div class="image-container">
                                ${resultImageHtml}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getTaskCardClass(task) {
            let cardClass = 'task-card';
            if (task.isOverdue) cardClass += ' overdue';
            if (task.isCompleted) cardClass += ' completed';
            return cardClass;
        }
        
        function generateProductImageHtml(task) {
            const productImageUrl = task.productImageUrl || task.productImage;
            const productSku = task.productSku || task.extractedSKU;
            
            if (productImageUrl) {
                const directImageUrl = convertGoogleDriveUrl(productImageUrl);
                return `
                    <div class="product-image-container">
                        <img src="${directImageUrl}" alt="Product" class="product-image" onclick="openImageModal(this.src)" onerror="handleImageError(this)" data-original-url="${productImageUrl}">
                        ${productSku ? '<div class="product-sku-badge">SKU: ' + productSku + '</div>' : ''}
                        <div class="image-source-badge">📦 Mr Ngoc Products</div>
                    </div>
                `;
            } else {
                return `
                    <div class="image-placeholder">
                        <div>Không có hình sản phẩm</div>
                        ${productSku ? '<div class="product-sku-badge">SKU: ' + productSku + '</div>' : ''}
                    </div>
                `;
            }
        }
        
        function generateResultImageHtml(task) {
            if (task.resultImageUrl) {
                const directImageUrl = convertGoogleDriveUrl(task.resultImageUrl);
                return `
                    <img src="${directImageUrl}" alt="Result" class="result-image" onclick="openImageModal(this.src)" onerror="handleImageError(this)" data-original-url="${task.resultImageUrl}">
                    <button onclick="uploadResultImage(this.dataset.workingCode, this.dataset.sheetName)" data-working-code="${task.workingCode}" data-sheet-name="${task.sheetName}" class="btn-upload-small">🔄 Thay đổi</button>
                `;
            } else {
                return `
                    <div class="image-placeholder">
                        <div>Chưa có kết quả</div>
                        <button onclick="uploadResultImage(this.dataset.workingCode, this.dataset.sheetName)" data-working-code="${task.workingCode}" data-sheet-name="${task.sheetName}" class="btn-upload">📤 Upload Result</button>
                    </div>
                `;
            }
        }
        
        function generateStatusHtml(task) {
            const deliveryStatus = task.isDelivered ? 
                '<span class="status-delivery status-delivered">●Đã giao task</span>' :
                '<span class="status-delivery status-pending">●Chưa giao task</span>';
                
            const doneStatus = task.isCompleted ? 
                '<span class="task-done done-completed" onclick="toggleTaskCompletion(' + task.workingCode + ')">✅ Đã xong</span>' :
                '<span class="task-done done-pending" onclick="toggleTaskCompletion(' + task.workingCode + ')">⏳ Chưa xong</span>';
            
            return `
                <div class="task-status">
                    ${deliveryStatus}
                </div>
                ${doneStatus}
            `;
        }
        
        function generateSkuBadge(task) {
            if (task.originalSKU) {
                return '<div class="task-sku-badge">SKU: ' + task.originalSKU + '</div>';
            } else {
                return '<div class="task-sku-badge task-sku-empty">SKU: ' + (task.extractedSKU || 'trống') + '</div>';
            }
        }
        
        function getDeadlineClass(task) {
            return task.isOverdue ? 'task-deadline urgent' : 'task-deadline normal';
        }
        
        function getCleanWorkingCode(workingCode) {
            if (!workingCode) return '';
            
            // Extract pattern: EE2-V5339-65 → V5339-65 (remove employee code prefix)
            const match = workingCode.match(/^[A-Z]+\d*-(.+)$/);
            return match ? match[1] : workingCode;
        }
        
        function convertGoogleDriveUrl(url) {
            if (!url) return url;
            
            // Check if it's a Google Drive URL
            if (url.includes('drive.google.com')) {
                // Extract file ID from various Google Drive URL formats:
                // https://drive.google.com/file/d/{fileId}/view
                // https://drive.google.com/open?id={fileId}
                // https://drive.google.com/uc?id={fileId}&export=download
                
                let fileId = null;
                
                // Pattern 1: /file/d/{fileId}/view
                let match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match) {
                    fileId = match[1];
                }
                
                // Pattern 2: ?id={fileId}
                if (!fileId) {
                    match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                    if (match) {
                        fileId = match[1];
                    }
                }
                
                // If we found a file ID, convert to direct image URL
                if (fileId) {
                    return 'https://drive.google.com/uc?export=view&id=' + fileId;
                }
            }
            
            // Return original URL if not a Google Drive link or can't parse
            return url;
        }
        
        // ===================================================================
        // STATISTICS AND UPDATES
        // ===================================================================
        
        function updateStats(tasks) {
            if (!tasks) return;
            
            const totalTasks = tasks.length;
            const pendingDelivery = tasks.filter(t => !t.isDelivered).length;
            const pendingCompletion = tasks.filter(t => !t.isCompleted).length;
            const overdueTasks = tasks.filter(t => t.isOverdue).length;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('pendingDelivery').textContent = pendingDelivery;
            document.getElementById('pendingCompletion').textContent = pendingCompletion;
            document.getElementById('overdueTasks').textContent = overdueTasks;
            
            // Show stats if there are tasks
            document.getElementById('statsSummary').style.display = totalTasks > 0 ? 'flex' : 'none';
        }
        
        // ===================================================================
        // IMAGE UPLOAD
        // ===================================================================
        
        function uploadResultImage(workingCode, sheetName) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        showStatus('❌ File quá lớn! Tối đa 10MB', 'error');
                        return;
                    }
                    
                    // Get employee name and refId for filename
                    const employeeName = document.getElementById('employeeSelector').value;
                    const task = currentTasks.find(t => t.workingCode === workingCode);
                    const refId = task ? task.refId : workingCode;
                    
                    showStatus('🔄 Đang upload ' + file.name + ' (' + (file.size/1024/1024).toFixed(1) + 'MB)...', 'loading');
                    
                    // Convert file to base64
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64Data = event.target.result.split(',')[1];
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    showStatus('✅ Upload thành công: ' + result.data.filename, 'success');
                                    
                                    // Show additional info
                                    setTimeout(() => {
                                        showStatus('📁 Lưu tại: ' + result.data.filePath, 'info');
                                    }, 2000);
                                    
                                    fetchTasks(); // Refresh to show new image
                                } else {
                                    showStatus('❌ Lỗi upload: ' + result.error, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                showStatus('❌ Lỗi hệ thống: ' + error.message, 'error');
                            })
                            .uploadTaskResultImageFromBase64(employeeName, refId, base64Data, file.type, file.name, workingCode);
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }
        
        // ===================================================================
        // BULK OPERATIONS
        // ===================================================================
        
        function confirmDelivery() {
            const selectedTasks = getSelectedTasks();
            if (selectedTasks.length === 0) {
                showStatus('❌ Vui lòng chọn ít nhất một task!', 'error');
                return;
            }
            
            showStatus('🔄 Đang xác nhận giao ' + selectedTasks.length + ' tasks...', 'loading');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showStatus(result.message, 'success');
                        fetchTasks(); // Refresh
                    } else {
                        showStatus('❌ Lỗi cập nhật: ' + result.error, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showStatus('❌ Lỗi cập nhật: ' + error.message, 'error');
                })
                .updateTasksDelivery(selectedTasks.map(t => ({ workingCode: t.workingCode, sheetName: t.sheetName })), true);
        }
        
        function markCompleted() {
            const selectedTasks = getSelectedTasks();
            if (selectedTasks.length === 0) {
                showStatus('❌ Vui lòng chọn ít nhất một task!', 'error');
                return;
            }
            
            showStatus('🔄 Đang đánh dấu hoàn thành ' + selectedTasks.length + ' tasks...', 'loading');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showStatus(result.message, 'success');
                        fetchTasks(); // Refresh
                    } else {
                        showStatus('❌ Lỗi cập nhật: ' + result.error, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showStatus('❌ Lỗi cập nhật: ' + error.message, 'error');
                })
                .updateTasksCompletion(selectedTasks.map(t => ({ workingCode: t.workingCode, sheetName: t.sheetName })), true);
        }
        
        function markIncomplete() {
            const selectedTasks = getSelectedTasks();
            if (selectedTasks.length === 0) {
                showStatus('❌ Vui lòng chọn ít nhất một task!', 'error');
                return;
            }
            
            showStatus('🔄 Đang bỏ đánh dấu hoàn thành ' + selectedTasks.length + ' tasks...', 'loading');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showStatus(result.message, 'success');
                        fetchTasks(); // Refresh
                    } else {
                        showStatus('❌ Lỗi cập nhật: ' + result.error, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showStatus('❌ Lỗi cập nhật: ' + error.message, 'error');
                })
                .updateTasksCompletion(selectedTasks.map(t => ({ workingCode: t.workingCode, sheetName: t.sheetName })), false);
        }
        
        function getSelectedTasks() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            return Array.from(checkboxes).map(cb => {
                const index = parseInt(cb.dataset.index);
                return currentTasks[index];
            });
        }
        
        // ===================================================================
        // TEST AND DEBUG FUNCTIONS
        // ===================================================================
        
        function testSystemComponents() {
            console.log('🧪 Testing system components...');
            showStatus('🧪 Đang test components...', 'loading');
            
            let tests = [];
            
            // Test 1: Date inputs
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const startDateEl = document.getElementById('startDate');
            const endDateEl = document.getElementById('endDate');
            
            if (startDateEl && endDateEl) {
                tests.push('✅ Date inputs found');
                startDateEl.value = todayStr;
                endDateEl.value = todayStr;
                tests.push('✅ Dates set to: ' + formatDateForDisplay(today));
            } else {
                tests.push('❌ Date inputs missing');
            }
            
            // Test 2: Employee selector
            const selector = document.getElementById('employeeSelector');
            if (selector) {
                tests.push('✅ Employee selector found');
                tests.push('📊 Options count: ' + selector.options.length);
            } else {
                tests.push('❌ Employee selector missing');
            }
            
            // Test 3: Load employees
            tests.push('🔄 Testing employee load...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    tests.push('✅ Employee function works: ' + result.success);
                    tests.push('📊 Employee count: ' + (result.count || 0));
                    
                    if (result.data && result.data.length > 0) {
                        tests.push('👤 First employee: ' + (result.data[0].name || result.data[0]));
                    }
                    
                    const testResults = tests.join('\n');
                    console.log('🧪 Test Results:\n', testResults);
                    
                    alert('🧪 System Component Test Results:\n\n' + testResults + '\n\n' + (result.message || ''));
                    showStatus('✅ Test completed! Check console and alert.', 'success');
                })
                .withFailureHandler(function(error) {
                    tests.push('❌ Employee function failed: ' + error.message);
                    
                    const testResults = tests.join('\n');
                    console.error('🧪 Test Results:\n', testResults);
                    
                    alert('🧪 System Component Test Results:\n\n' + testResults);
                    showStatus('❌ Test completed with errors!', 'error');
                })
                .getEmployeeListFromSettings();
        }
        
        // ===================================================================
        // UTILITY FUNCTIONS
        // ===================================================================
        
        function openImageModal(imageUrl) {
            window.open(imageUrl, '_blank');
        }
        
        function handleImageError(imgElement) {
            const originalUrl = imgElement.getAttribute('data-original-url');
            console.log('Image failed to load:', imgElement.src);
            console.log('Original URL:', originalUrl);
            
            // Try fallback approaches
            if (originalUrl && imgElement.src !== originalUrl) {
                // If we converted a Google Drive URL and it failed, try the original
                console.log('Trying original URL as fallback...');
                imgElement.src = originalUrl;
            } else {
                // Replace with placeholder
                imgElement.style.display = 'none';
                imgElement.parentElement.innerHTML = `
                    <div class="image-placeholder" style="background: #f8f9fa; border: 2px dashed #ddd;">
                        <div style="color: #666;">🖼️ Không thể tải hình</div>
                        <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                            <a href="${originalUrl || imgElement.src}" target="_blank" style="color: #007bff;">Xem link gốc</a>
                        </div>
                    </div>
                `;
            }
        }
        
        function toggleTaskCompletion(workingCode) {
            const task = currentTasks.find(t => t.workingCode === workingCode);
            if (!task) {
                showStatus('❌ Task không tìm thấy!', 'error');
                return;
            }
            
            const newStatus = !task.isCompleted;
            showStatus('🔄 Đang cập nhật trạng thái task #' + workingCode + '...', 'loading');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showStatus(newStatus ? '✅ Đã đánh dấu hoàn thành!' : '⏳ Đã bỏ đánh dấu hoàn thành!', 'success');
                        fetchTasks(); // Refresh
                    } else {
                        showStatus('❌ Lỗi cập nhật: ' + result.error, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showStatus('❌ Lỗi cập nhật: ' + error.message, 'error');
                })
                .updateTasksCompletion([{ workingCode: workingCode, sheetName: task.sheetName }], newStatus);
        }
        
        function exportTaskVisual(index) {
            // Placeholder for export functionality
            const task = currentTasks[index];
            showStatus('📋 Export function for task #' + task.workingCode + ' - coming soon!', 'info');
        }
        
        
        function runDebug() {
            showStatus('🔧 Đang chạy debug system...', 'loading');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Debug result:', result);
                    
                    let message = 'Debug System completed!\n';
                    message += '✅ Success: ' + result.success + '\n';
                    message += '📊 Total modules: ' + (result.modules ? result.modules.length : 0) + '\n';
                    message += '🔧 Functions available: ' + (result.functions ? result.functions.length : 0) + '\n';
                    
                    if (result.employees) {
                        message += '👥 Employees found: ' + result.employees.length + '\n';
                    }
                    
                    if (result.tasks) {
                        message += '📋 Tasks found: ' + result.tasks.length + '\n';
                    }
                    
                    if (result.errors && result.errors.length > 0) {
                        message += '❌ Errors: ' + result.errors.length + '\n';
                        result.errors.forEach(error => {
                            message += '  - ' + error + '\n';
                        });
                    }
                    
                    alert(message);
                    showStatus('✅ Debug completed! Check console for details.', 'success');
                })
                .withFailureHandler(function(error) {
                    console.error('Debug failed:', error);
                    alert('Debug failed: ' + error.message);
                    showStatus('❌ Debug failed: ' + error.message, 'error');
                })
                .debugEmployeeSystemComplete();
        }
        
        function testConnectivity() {
            showStatus('🔗 Testing backend connectivity...', 'loading');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('🔗 Connectivity test result:', result);
                    
                    if (result && result.success) {
                        showStatus('✅ Backend connectivity OK: ' + result.data.message, 'success');
                        alert('✅ Backend Connected!\nTimestamp: ' + result.data.timestamp);
                    } else {
                        showStatus('❌ Connectivity test failed: ' + (result ? result.error : 'No response'), 'error');
                        alert('❌ Connectivity Failed: ' + (result ? result.error : 'No response'));
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Connectivity test failed:', error);
                    showStatus('❌ Backend connection failed: ' + error.message, 'error');
                    alert('❌ Backend Connection Failed: ' + error.message);
                })
                .testBasicConnectivity();
        }
        
        
        
        // ===================================================================
        // INITIALIZATION
        // ===================================================================
        
        // Initialize page
        window.onload = function() {
            console.log('🚀 Employee Tasks page initializing...');
            
            // Use force reload to ensure everything works
            setTimeout(() => {
                forceSetDatesAndLoadEmployees();
            }, 500);
            
            showStatus('🚀 Employee Tasks initialized!', 'success');
        };
        
        // Make all functions globally available
        window.testSystemComponents = testSystemComponents;
        window.forceSetDatesAndLoadEmployees = forceSetDatesAndLoadEmployees;
        window.loadHardcodedEmployees = loadHardcodedEmployees;
        window.showStatus = showStatus;
        window.formatDateForDisplay = formatDateForDisplay;
        window.fetchTasks = fetchTasks;
        window.confirmDelivery = confirmDelivery;
        window.markCompleted = markCompleted;
        window.markIncomplete = markIncomplete;
        window.uploadResultImage = uploadResultImage;
        window.runDebug = runDebug;
        
        console.log('✅ Employee Tasks page loaded - corrected architecture');
    </script>
</body>
</html>