<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∑Ô∏è In nh√£n g·ª≠i h√†ng</title>
    <?!= include('shared-styles'); ?>
    <style>
        /* Main UI Styles */
        .controls-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .controls-row:last-child {
            margin-bottom: 0;
        }
        
        .btn-white {
            background: white;
            color: #667eea;
            border: 2px solid white;
            font-weight: 600;
        }
        
        .btn-white:hover {
            background: #f8f9fa;
            color: #5a6fd8;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        /* Orders Table */
        .orders-container {
            margin: 25px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .orders-table th {
            background: #667eea;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .orders-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }
        
        .orders-table tr:hover {
            background: #f8f9fa;
        }
        
        .orders-table input[type="checkbox"] {
            transform: scale(1.3);
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .ref-id {
            font-weight: 600;
            color: #333;
        }
        
        .receiver-name {
            font-weight: 500;
            color: #495057;
        }
        
        .address-preview {
            font-size: 0.85em;
            color: #6c757d;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Labels Preview */
        .labels-preview {
            margin-top: 30px;
        }
        
        .labels-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 20px 0;
            align-items: stretch;
            justify-items: stretch;
        }
        
        .label-box {
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 10px;
            height: 150px;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 12px;
            line-height: 1.3;
            position: relative;
            page-break-inside: avoid;
            break-inside: avoid;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .label-ref {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 6px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .label-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
            color: #000;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .label-address {
            color: #333;
            line-height: 1.1;
            font-size: 11px;
            flex: 1;
            overflow: hidden;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
        }
        
        .label-address div {
            margin: 1px 0;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Print Styles */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                font-family: Arial, Helvetica, sans-serif !important;
                color: #000 !important;
            }
            
            /* Hide all UI elements completely */
            .no-print, .navbar, .controls-section, .stats-grid, .orders-container, 
            .card-header, .empty-state, h1, h2, h3, p, .message, #status {
                display: none !important;
                visibility: hidden !important;
            }
            
            .container {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
            
            .card {
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
                background: white !important;
            }
            
            .labels-preview {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .labels-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 8px !important;
                padding: 10px !important;
                width: 100% !important;
                align-items: stretch !important;
                justify-items: stretch !important;
                align-content: start !important;
            }
            
            .label-box {
                border: 1px solid #000 !important;
                box-shadow: none !important;
                padding: 4px !important;
                height: 120px !important;
                width: calc(25% - 4px) !important; /* Slightly smaller for fit */
                min-width: 165px !important; /* Reduce min-width */
                max-width: 185px !important; /* Reduce max-width */
                font-family: Arial, Helvetica, sans-serif !important;
                font-size: 10px !important;
                line-height: 1.1 !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                background: white !important;
                color: #000 !important;
                display: flex !important;
                flex-direction: column !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                word-wrap: break-word !important;
                word-break: break-word !important;
                hyphens: auto !important;
                margin: 0 !important;
            }
            
            .label-ref {
                font-weight: bold !important;
                font-size: 11px !important;
                margin-bottom: 3px !important;
                color: #000 !important;
                border-bottom: 1px solid #000 !important;
                padding-bottom: 1px !important;
                font-family: Arial, Helvetica, sans-serif !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
            }
            
            .label-name {
                font-weight: bold !important;
                font-size: 10px !important;
                margin-bottom: 2px !important;
                color: #000 !important;
                font-family: Arial, Helvetica, sans-serif !important;
                overflow: hidden !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
                word-wrap: break-word !important;
                word-break: break-word !important;
                hyphens: auto !important;
                line-height: 1.1 !important;
            }
            
            .label-address {
                color: #000 !important;
                line-height: 1.1 !important;
                font-size: 9px !important;
                font-family: Arial, Helvetica, sans-serif !important;
                flex: 1 !important;
                overflow: hidden !important;
                word-wrap: break-word !important;
                word-break: break-word !important;
                hyphens: auto !important;
            }
            
            .label-address div {
                margin: 0 !important;
                padding: 0 !important;
                font-family: Arial, Helvetica, sans-serif !important;
                word-wrap: break-word !important;
                word-break: break-word !important;
                hyphens: auto !important;
                line-height: 1.1 !important;
                overflow-wrap: break-word !important;
            }
            
            .page-break {
                page-break-before: always !important;
                break-before: page !important;
            }
            
            @page {
                size: A4 portrait !important;
                margin: 0.4in !important;
            }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .orders-table {
                font-size: 0.8em;
            }
            
            .orders-table th,
            .orders-table td {
                padding: 8px 5px;
            }
            
            .labels-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="?" class="navbar-brand">üè¢ H·ªá th·ªëng qu·∫£n l√Ω</a>
        <div class="navbar-nav">
            <a href="?" class="nav-link">üè† Trang ch·ªß</a>
            <a href="?page=extract-orders" class="nav-link">üì¶ ƒê√≥ng g√≥i ƒë∆°n h√†ng</a>
            <a href="?page=label-script" class="nav-link">üè∑Ô∏è In nh√£n g·ª≠i h√†ng</a>
            <a href="?page=employee-tasks" class="nav-link">üë• Qu·∫£n l√Ω s·∫£n xu·∫•t</a>
            <a href="?page=inventory" class="nav-link">üìä Qu·∫£n l√Ω t·ªìn kho</a>
            <a href="?page=reports" class="nav-link">üìà B√°o c√°o & Ph√¢n t√≠ch</a>
            <a href="?page=setting" class="nav-link">‚öôÔ∏è C·∫•u h√¨nh h·ªá th·ªëng</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">üè∑Ô∏è In tem v·∫≠n chuy·ªÉn</h1>
            </div>
            
            <div class="controls-section no-print">
                <div class="controls-row">
                    <button onclick="fetchOrders()" class="btn btn-white" id="fetchBtn">
                        üîÑ Fetch Orders
                    </button>
                    <button onclick="selectAll()" class="btn btn-white" id="selectAllBtn" disabled>
                        ‚òëÔ∏è Select All
                    </button>
                    <button onclick="deselectAll()" class="btn btn-white" id="deselectAllBtn" disabled>
                        ‚òê Deselect All
                    </button>
                    <button onclick="generateLabels()" class="btn btn-white" id="generateBtn" disabled>
                        üè∑Ô∏è Generate Labels
                    </button>
                    <button onclick="toggleCarrierFilter()" class="btn btn-white" id="carrierFilterBtn">
                        üö´ Carrier Filter
                    </button>
                </div>
                
                <div class="controls-row" id="carrierFilterRow" style="display: none; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px; margin-top: 10px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <span style="font-weight: 600; opacity: 0.9;">üö´ Lo·∫°i tr·ª´ Carrier:</span>
                        <div id="carrierCheckboxes" style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <!-- Carrier checkboxes will be populated here -->
                        </div>
                        <button onclick="applyCarrierFilter()" class="btn btn-white" style="padding: 6px 12px; font-size: 0.9em;">
                            ‚úÖ √Åp d·ª•ng
                        </button>
                    </div>
                </div>
                
                <div class="controls-row">
                    <button onclick="printLabels()" class="btn btn-white" id="printBtn" disabled>
                        üñ®Ô∏è Print Labels
                    </button>
                    <button onclick="clearPreview()" class="btn btn-white" id="clearBtn" disabled>
                        üóëÔ∏è Clear Preview
                    </button>
                    <span style="font-size: 0.9em; opacity: 0.8;">
                        üí° Tip: Ch·ªçn ƒë∆°n h√†ng ‚Üí Generate ‚Üí Print
                    </span>
                </div>
            </div>
            
            <div id="status"></div>
            
            <div class="stats-grid no-print" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">T·ªïng ƒë∆°n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedOrders">0</div>
                    <div class="stat-label">ƒê√£ ch·ªçn</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="generatedLabels">0</div>
                    <div class="stat-label">Labels t·∫°o</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="estimatedPages">0</div>
                    <div class="stat-label">Trang in</div>
                </div>
            </div>
            
            <div class="orders-container no-print" id="ordersContainer" style="display: none;">
                <table class="orders-table" id="ordersTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">‚úì</th>
                            <th style="width: 120px;">Ref ID</th>
                            <th style="width: 180px;">Ng∆∞·ªùi nh·∫≠n</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th style="width: 100px;">Th√†nh ph·ªë</th>
                            <th style="width: 80px;">M√£ zip</th>
                            <th style="width: 100px;">Local Carrier</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                    </tbody>
                </table>
            </div>
            
            <div id="content">
                <div class="empty-state">
                    <h3>üöÄ S·∫µn s√†ng t·∫°o tem v·∫≠n chuy·ªÉn</h3>
                    <p>Click "Fetch Orders" ƒë·ªÉ l·∫•y danh s√°ch ƒë∆°n h√†ng ch∆∞a g·ª≠i</p>
                    <p style="font-size: 0.9em; color: #999; margin-top: 15px;">
                        H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông l·∫•y c√°c ƒë∆°n c√≥ c·ªôt "Send" tr·ªëng
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let selectedOrders = [];
        let generatedLabels = [];
        let allCarriers = [];
        let excludedCarriers = ['NGOC']; // Default exclude NGOC
        let carrierFilterVisible = false;

        // Show status message
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalOrders').textContent = allOrders.length;
            document.getElementById('selectedOrders').textContent = selectedOrders.length;
            document.getElementById('generatedLabels').textContent = generatedLabels.length;
            document.getElementById('estimatedPages').textContent = Math.ceil(generatedLabels.length / 20);
            
            // Show stats section if there are orders
            document.getElementById('statsSection').style.display = allOrders.length > 0 ? 'grid' : 'none';
        }

        // Update button states
        function updateButtons() {
            const hasOrders = allOrders.length > 0;
            const hasSelected = selectedOrders.length > 0;
            const hasLabels = generatedLabels.length > 0;
            
            document.getElementById('selectAllBtn').disabled = !hasOrders;
            document.getElementById('deselectAllBtn').disabled = !hasOrders;
            document.getElementById('generateBtn').disabled = !hasSelected;
            document.getElementById('printBtn').disabled = !hasLabels;
            document.getElementById('clearBtn').disabled = !hasLabels;
        }

        // Toggle carrier filter visibility
        function toggleCarrierFilter() {
            carrierFilterVisible = !carrierFilterVisible;
            const filterRow = document.getElementById('carrierFilterRow');
            const filterBtn = document.getElementById('carrierFilterBtn');
            
            if (carrierFilterVisible) {
                filterRow.style.display = 'block';
                filterBtn.textContent = 'üîº Hide Filter';
                populateCarrierCheckboxes();
                
                // Show current status
                if (allCarriers.length > 0) {
                    showStatus(`üö´ Hi·ªán c√≥ ${allCarriers.length} carriers: ${allCarriers.join(', ')}`, 'success');
                }
            } else {
                filterRow.style.display = 'none';
                filterBtn.textContent = 'üö´ Carrier Filter';
            }
        }

        // Populate carrier checkboxes
        function populateCarrierCheckboxes() {
            const container = document.getElementById('carrierCheckboxes');
            
            if (allCarriers.length === 0) {
                container.innerHTML = '<span style="opacity: 0.7; font-size: 0.9em;">üì¶ Fetch Orders tr∆∞·ªõc ƒë·ªÉ xem carriers</span>';
                return;
            }
            
            let html = `<span style="margin-right: 10px; font-size: 0.85em; opacity: 0.8;">
                        T√¨m th·∫•y ${allCarriers.length} carriers:</span>`;
            
            allCarriers.forEach(carrier => {
                const isChecked = excludedCarriers.includes(carrier) ? 'checked' : '';
                const carrierClass = carrier === 'NGOC' ? 'style="color: #ff6b6b; font-weight: 600;"' : '';
                
                html += `
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer; margin-left: 10px;" ${carrierClass}>
                        <input type="checkbox" value="${carrier}" ${isChecked} 
                               style="transform: scale(1.1); cursor: pointer;">
                        <span>${carrier}</span>
                    </label>
                `;
            });
            
            container.innerHTML = html;
        }

        // Apply carrier filter
        function applyCarrierFilter() {
            const checkboxes = document.querySelectorAll('#carrierCheckboxes input[type="checkbox"]');
            excludedCarriers = [];
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    excludedCarriers.push(cb.value);
                }
            });
            
            showStatus(`üö´ ƒê√£ lo·∫°i tr·ª´: ${excludedCarriers.join(', ') || 'Kh√¥ng c√≥'}`, 'success');
            
            // Auto re-fetch with new filter
            setTimeout(() => {
                fetchOrders();
            }, 1000);
        }
        // Fetch orders from Google Sheets
        function fetchOrders() {
            showStatus('üîÑ ƒêang l·∫•y danh s√°ch ƒë∆°n h√†ng...', 'loading');
            
            // Reset state
            allOrders = [];
            selectedOrders = [];
            generatedLabels = [];
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        allOrders = result.data;
                        allCarriers = result.allCarriers || [];
                        
                        // Debug log
                        console.log('üìä Fetch Result:', result);
                        console.log('üö´ All Carriers Found:', allCarriers);
                        console.log('üö´ Excluded Carriers:', excludedCarriers);
                        
                        renderOrdersTable();
                        updateStats();
                        updateButtons();
                        
                        // Update carrier filter info
                        const excludeInfo = result.excludedCarriers && result.excludedCarriers.length > 0 
                            ? ` (Lo·∫°i tr·ª´: ${result.excludedCarriers.join(', ')})` 
                            : '';
                        
                        showStatus(`‚úÖ ${result.message}${excludeInfo}`, 'success');
                        
                        // Auto-populate carrier filter sau khi fetch
                        setTimeout(() => {
                            populateCarrierCheckboxes();
                            console.log('üö´ Available Carriers:', allCarriers);
                            console.log('üö´ Currently Excluded:', excludedCarriers);
                        }, 100);
                        
                    } else {
                        showStatus(`‚ùå L·ªói: ${result.error}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showStatus(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi: ${error.message}`, 'error');
                })
                .getShippingOrdersForLabels(excludedCarriers); // ‚Üê FIX: Truy·ªÅn excludedCarriers
        }

        // Render orders table
        function renderOrdersTable() {
            const container = document.getElementById('ordersContainer');
            const tbody = document.getElementById('ordersTableBody');
            
            if (allOrders.length === 0) {
                container.style.display = 'none';
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</h3>
                        <p>T·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu</p>
                        <p style="font-size: 0.9em; color: #999;">
                            Ki·ªÉm tra l·∫°i sheet "Shipping" v√† c·ªôt "Send"
                        </p>
                    </div>
                `;
                return;
            }
            
            container.style.display = 'block';
            
            let html = '';
            allOrders.forEach((order, index) => {
                const fullAddress = [
                    order.addressLine1,
                    order.addressLine2,
                    order.city,
                    order.state,
                    order.postcode,
                    order.country
                ].filter(item => item && item.trim()).join(', ');
                
                html += `
                    <tr>
                        <td style="text-align: center;">
                            <input type="checkbox" 
                                   id="order_${index}" 
                                   onchange="toggleOrder(${index})"
                                   ${order.selected ? 'checked' : ''}>
                        </td>
                        <td class="ref-id">${order.refId}</td>
                        <td class="receiver-name">${order.receiverName}</td>
                        <td class="address-preview" title="${fullAddress}">${fullAddress}</td>
                        <td>${order.city}</td>
                        <td>${order.postcode}</td>
                        <td style="font-weight: 600; color: ${order.localCarrier === 'NGOC' ? '#ff6b6b' : '#495057'};">
                            ${order.localCarrier || 'N/A'}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Clear content preview
            document.getElementById('content').innerHTML = '';
        }

        // Toggle order selection
        function toggleOrder(index) {
            const order = allOrders[index];
            order.selected = !order.selected;
            
            if (order.selected) {
                selectedOrders.push(order);
            } else {
                selectedOrders = selectedOrders.filter(o => o.refId !== order.refId);
            }
            
            updateStats();
            updateButtons();
        }

        // Select all orders
        function selectAll() {
            allOrders.forEach((order, index) => {
                order.selected = true;
                document.getElementById(`order_${index}`).checked = true;
            });
            
            selectedOrders = [...allOrders];
            updateStats();
            updateButtons();
            showStatus('‚úÖ ƒê√£ ch·ªçn t·∫•t c·∫£ ƒë∆°n h√†ng', 'success');
        }

        // Deselect all orders
        function deselectAll() {
            allOrders.forEach((order, index) => {
                order.selected = false;
                document.getElementById(`order_${index}`).checked = false;
            });
            
            selectedOrders = [];
            updateStats();
            updateButtons();
            showStatus('‚úÖ ƒê√£ b·ªè ch·ªçn t·∫•t c·∫£ ƒë∆°n h√†ng', 'success');
        }

        // Generate labels preview
        function generateLabels() {
            if (selectedOrders.length === 0) {
                showStatus('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ƒë∆°n h√†ng', 'error');
                return;
            }
            
            showStatus('üè∑Ô∏è ƒêang t·∫°o labels...', 'loading');
            
            // Generate labels from selected orders
            generatedLabels = selectedOrders.map(order => ({
                refId: order.refId,
                receiverName: order.receiverName,
                addressLines: [
                    order.addressLine1,
                    order.addressLine2,
                    order.city,
                    order.state,
                    order.postcode,
                    order.country
                ].filter(line => line && line.trim())
            }));
            
            renderLabelsPreview();
            updateStats();
            updateButtons();
            
            showStatus(`‚úÖ ƒê√£ t·∫°o ${generatedLabels.length} labels`, 'success');
            
            // Scroll to preview
            document.getElementById('content').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // Render labels preview
        function renderLabelsPreview() {
            if (generatedLabels.length === 0) return;
            
            let html = '<div class="labels-preview">';
            html += '<h3 style="margin-bottom: 20px;">üìã Preview Labels (4 c·ªôt √ó 5 h√†ng = 20 labels/trang)</h3>';
            html += '<div class="labels-grid">';
            
            generatedLabels.forEach((label, index) => {
                // Add page break every 20 labels (4x5)
                const pageBreakClass = (index > 0 && index % 20 === 0) ? 'page-break' : '';
                
                html += `
                    <div class="label-box ${pageBreakClass}" data-index="${index}">
                        <div class="label-ref">${label.refId}</div>
                        <div class="label-name">${label.receiverName}</div>
                        <div class="label-address">
                            ${label.addressLines.map(line => `<div>${line}</div>`).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            document.getElementById('content').innerHTML = html;
            
            // Debug: Check grid layout
            console.log(`üè∑Ô∏è Generated ${generatedLabels.length} labels`);
            console.log(`üìÑ Estimated pages: ${Math.ceil(generatedLabels.length / 20)}`);
        }

        // Print labels
        function printLabels() {
            if (generatedLabels.length === 0) {
                showStatus('‚ùå Ch∆∞a c√≥ labels ƒë·ªÉ in. Vui l√≤ng generate tr∆∞·ªõc.', 'error');
                return;
            }
            
            showStatus('üñ®Ô∏è ƒêang chu·∫©n b·ªã in...', 'loading');
            
            // Small delay to show the status
            setTimeout(() => {
                window.print();
                showStatus('‚úÖ ƒê√£ g·ª≠i l·ªánh in. Ki·ªÉm tra m√°y in c·ªßa b·∫°n.', 'success');
            }, 500);
        }

        // Clear preview
        function clearPreview() {
            generatedLabels = [];
            selectedOrders = [];
            
            // Uncheck all checkboxes
            allOrders.forEach((order, index) => {
                order.selected = false;
                const checkbox = document.getElementById(`order_${index}`);
                if (checkbox) checkbox.checked = false;
            });
            
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <h3>üè∑Ô∏è Preview ƒë√£ ƒë∆∞·ª£c x√≥a</h3>
                    <p>Ch·ªçn ƒë∆°n h√†ng v√† click "Generate Labels" ƒë·ªÉ t·∫°o preview m·ªõi</p>
                </div>
            `;
            
            updateStats();
            updateButtons();
            showStatus('‚úÖ ƒê√£ x√≥a preview v√† reset selection', 'success');
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl + P for print
                if (e.ctrlKey && e.key === 'p' && generatedLabels.length > 0) {
                    e.preventDefault();
                    printLabels();
                }
                
                // Ctrl + A for select all (when orders table is visible)
                if (e.ctrlKey && e.key === 'a' && allOrders.length > 0) {
                    e.preventDefault();
                    selectAll();
                }
                
                // Ctrl + D for deselect all
                if (e.ctrlKey && e.key === 'd' && allOrders.length > 0) {
                    e.preventDefault();
                    deselectAll();
                }
                
                // Ctrl + G for generate labels
                if (e.ctrlKey && e.key === 'g' && selectedOrders.length > 0) {
                    e.preventDefault();
                    generateLabels();
                }
                
                // F5 or Ctrl + R for refresh (fetch orders)
                if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                    e.preventDefault();
                    fetchOrders();
                }
            });
        }

        // Auto-fetch orders on page load
        function initializePage() {
            showStatus('üîÑ ƒêang kh·ªüi t·∫°o...', 'loading');
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Add tooltips to buttons
            document.getElementById('fetchBtn').title = 'F5 ho·∫∑c Ctrl+R';
            document.getElementById('selectAllBtn').title = 'Ctrl+A';
            document.getElementById('deselectAllBtn').title = 'Ctrl+D';
            document.getElementById('generateBtn').title = 'Ctrl+G';
            document.getElementById('printBtn').title = 'Ctrl+P';
            
            // Auto-fetch orders
            setTimeout(() => {
                fetchOrders();
            }, 500);
        }

        // Handle print events
        window.addEventListener('beforeprint', function() {
            if (generatedLabels.length === 0) {
                alert('‚ùå Kh√¥ng c√≥ labels ƒë·ªÉ in!');
                return false;
            }
            
            // Hide all status messages during print
            document.getElementById('status').style.display = 'none';
        });

        window.addEventListener('afterprint', function() {
            // Re-show status after print
            document.getElementById('status').style.display = 'block';
            showStatus('‚úÖ Ho√†n t·∫•t in ·∫•n!', 'success');
        });

        // Error handling for Google Apps Script
        function handleScriptError(error) {
            console.error('Script Error:', error);
            showStatus(`‚ùå L·ªói h·ªá th·ªëng: ${error.message}`, 'error');
        }

        // Initialize page when loaded
        window.onload = initializePage;

        // Add some visual feedback
        document.addEventListener('DOMContentLoaded', function() {
            // Add click animations to buttons
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });
            
            // Add loading animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .loading .btn::before {
                    content: '‚è≥ ';
                    animation: spin 1s linear infinite;
                }
                
                .table-hover tr:hover {
                    background-color: #f8f9fa !important;
                    transform: scale(1.01);
                    transition: all 0.2s ease;
                }
            `;
            document.head.appendChild(style);
        });

        // Performance monitoring
        console.log('üè∑Ô∏è Shipping Labels System Initialized');
        console.log('üìä Features: Fetch ‚Üí Select ‚Üí Generate ‚Üí Print');
        console.log('‚å®Ô∏è Shortcuts: F5(Fetch), Ctrl+A(Select All), Ctrl+G(Generate), Ctrl+P(Print)');
    </script>
</body>
</html>