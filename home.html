<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng qu·∫£n l√Ω ph√≤ng ban</title>
    <?!= include('shared-styles'); ?>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        }
        
        .menu-card {
            position: relative;
            overflow: hidden;
        }
        
        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .menu-card:hover::before {
            left: 100%;
        }
        
        .menu-card:active {
            transform: translateY(-3px) scale(0.98);
        }
        
        .quick-info {
            text-align: center;
            margin-top: 30px;
            color: #666;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
        }
        
        .current-url {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div>üîÑ ƒêang t·∫£i h·ªá th·ªëng...</div>
            <div style="font-size: 14px; margin-top: 10px;">Vui l√≤ng ch·ªù trong gi√¢y l√°t</div>
        </div>
    </div>

    <div class="home-container">
        <div class="home-header">
            <h1>üè¢ H·ªá th·ªëng qu·∫£n l√Ω ph√≤ng ban</h1>
            <p class="subtitle">Ch·ªçn ch·ª©c nƒÉng b·∫°n mu·ªën s·ª≠ d·ª•ng</p>
        </div>
        
        <div class="menu-grid" id="menuGrid">
            <!-- Menu items will be populated by JavaScript -->
        </div>
        
        <div class="quick-info">
            <div><strong>üìç URL hi·ªán t·∫°i:</strong></div>
            <div class="current-url" id="currentUrl">ƒêang t·∫£i...</div>
            <div style="font-size: 0.9em; margin-top: 10px;">
                <strong>üöÄ Navigation:</strong> Direct URL linking cho t·ªëc ƒë·ªô t·ªëi ∆∞u
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 40px; color: #666;">
            <p>¬© 2025 H·ªá th·ªëng qu·∫£n l√Ω ph√≤ng ban. Powered by Google Apps Script.</p>
        </div>
    </div>

    <script>
        // Get current base URL - Fixed ƒë·ªÉ l·∫•y ƒë√∫ng deployment URL
        function getCurrentBaseUrl() {
            // Th·ª≠ l·∫•y t·ª´ parent window tr∆∞·ªõc (n·∫øu trong iframe)
            try {
                if (window.parent && window.parent !== window && window.parent.location.href) {
                    const parentUrl = window.parent.location.href;
                    if (parentUrl.includes('script.google.com/macros')) {
                        return parentUrl.split('?')[0];
                    }
                }
            } catch (e) {
                // CORS restriction, fallback to current window
            }
            
            // L·∫•y t·ª´ current window
            const currentUrl = window.location.href.split('?')[0];
            
            // N·∫øu l√† internal URL, construct deployment URL
            if (currentUrl.includes('googleusercontent.com') || currentUrl.includes('/dev')) {
                // Return a placeholder or prompt user
                return 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';
            }
            
            return currentUrl;
        }
        
        // Detect deployment URL intelligently
        function getDeploymentUrl() {
            // Method 1: Try t·ª´ URL parameters n·∫øu c√≥
            const urlParams = new URLSearchParams(window.location.search);
            const deployUrl = urlParams.get('deploy_url');
            if (deployUrl) {
                return deployUrl;
            }
            
            // Method 2: Check if we're in production deployment
            const currentUrl = window.location.href;
            if (currentUrl.includes('/exec') || currentUrl.includes('/dev')) {
                return currentUrl.split('?')[0];
            }
            
            // Method 3: Try to get from document referrer
            if (document.referrer && document.referrer.includes('script.google.com/macros')) {
                return document.referrer.split('?')[0];
            }
            
            // Method 4: Fallback - ask user to configure
            return null;
        }
        
        // Menu configuration
        const menuItems = [
            {
                page: 'extract-orders',
                icon: 'üì¶',
                title: 'Tr√≠ch xu·∫•t ƒë∆°n h√†ng',
                description: 'T√¨m ki·∫øm v√† qu·∫£n l√Ω ƒë∆°n h√†ng theo kho·∫£ng th·ªùi gian, c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√≥ng g√≥i',
                class: 'extract'
            },
            {
                page: 'shipping-labels',
                icon: 'üè∑Ô∏è',
                title: 'In tem v·∫≠n chuy·ªÉn',
                description: 'T·∫°o v√† in tem shipping labels t·ª´ d·ªØ li·ªáu Google Sheets, layout t·ªëi ∆∞u cho in A4',
                class: 'labels'
            },
            {
                page: 'employee-tasks',
                icon: 'üë•',
                title: 'Giao vi·ªác nh√¢n vi√™n',
                description: 'Qu·∫£n l√Ω v√† theo d√µi c√¥ng vi·ªác ƒë∆∞·ª£c giao cho t·ª´ng nh√¢n vi√™n, c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n th√†nh',
                class: 'inventory'
            },
            {
                page: 'inventory',
                icon: 'üìä',
                title: 'Qu·∫£n l√Ω kho',
                description: 'Theo d√µi t·ªìn kho, c·∫£nh b√°o h·∫øt h√†ng, qu·∫£n l√Ω nh·∫≠p xu·∫•t',
                class: 'reports'
            },
            {
                page: 'reports',
                icon: 'üìà',
                title: 'B√°o c√°o',
                description: 'T·∫°o c√°c b√°o c√°o doanh thu, th·ªëng k√™ b√°n h√†ng, ph√¢n t√≠ch d·ªØ li·ªáu',
                class: 'settings'
            },
            {
                page: 'settings',
                icon: '‚öôÔ∏è',
                title: 'C√†i ƒë·∫∑t',
                description: 'C·∫•u h√¨nh h·ªá th·ªëng, qu·∫£n l√Ω ng∆∞·ªùi d√πng, thi·∫øt l·∫≠p th√¥ng b√°o',
                class: 'settings'
            }
        ];
        
        // Generate menu HTML with direct URLs
        function generateMenu() {
            const baseUrl = getDeploymentUrl();
            const menuGrid = document.getElementById('menuGrid');
            
            if (!baseUrl) {
                // Show setup instructions if URL not detected
                menuGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: rgba(255,255,255,0.9); border-radius: 8px;">
                        <h3>üîß C·∫ßn c·∫•u h√¨nh URL Deployment</h3>
                        <p>Vui l√≤ng copy <strong>Deployment URL</strong> c·ªßa b·∫°n v√† paste v√†o √¥ b√™n d∆∞·ªõi:</p>
                        <input type="url" id="deployUrlInput" placeholder="https://script.google.com/macros/s/.../exec" 
                               style="width: 100%; max-width: 600px; padding: 10px; margin: 10px 0; border: 2px solid #ddd; border-radius: 4px;">
                        <br>
                        <button onclick="setDeploymentUrl()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üíæ L∆∞u v√† t·∫°o menu
                        </button>
                        <p style="font-size: 0.9em; color: #666; margin-top: 15px;">
                            <strong>C√°ch l·∫•y Deployment URL:</strong><br>
                            1. V√†o Apps Script Editor<br>
                            2. Deploy ‚Üí Manage deployments<br>
                            3. Copy URL t·ª´ "Web app"
                        </p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            menuItems.forEach(item => {
                const directUrl = `${baseUrl}?page=${item.page}`;
                
                html += `
                    <a href="${directUrl}" class="menu-card ${item.class}" onclick="showLoading('${item.title}')">
                        <span class="card-icon">${item.icon}</span>
                        <div class="card-title-menu">${item.title}</div>
                        <div class="card-desc">${item.description}</div>
                    </a>
                `;
            });
            
            menuGrid.innerHTML = html;
        }
        
        // Set deployment URL manually
        function setDeploymentUrl() {
            const url = document.getElementById('deployUrlInput').value.trim();
            if (!url) {
                alert('Vui l√≤ng nh·∫≠p URL deployment!');
                return;
            }
            
            if (!url.includes('script.google.com/macros')) {
                alert('URL kh√¥ng h·ª£p l·ªá! C·∫ßn l√† Google Apps Script URL.');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('deploymentUrl', url);
            
            // Regenerate menu
            generateMenu();
            updateCurrentUrl();
            
            // Show success
            showTemporaryMessage('‚úÖ ƒê√£ l∆∞u URL deployment! Menu ƒë√£ ƒë∆∞·ª£c t·∫°o.');
        }
        
        // Get stored deployment URL
        function getStoredDeploymentUrl() {
            return localStorage.getItem('deploymentUrl');
        }
        
        // Enhanced deployment URL detection
        function getDeploymentUrl() {
            // Try stored URL first
            const stored = getStoredDeploymentUrl();
            if (stored) return stored;
            
            // Try current URL detection
            const currentUrl = window.location.href;
            
            // If we're in actual deployment
            if (currentUrl.includes('script.google.com/macros') && 
                (currentUrl.includes('/exec') || currentUrl.includes('/dev'))) {
                const baseUrl = currentUrl.split('?')[0];
                // Auto-save for future use
                localStorage.setItem('deploymentUrl', baseUrl);
                return baseUrl;
            }
            
            return null;
        }
        
        // Show temporary message
        function showTemporaryMessage(message) {
            const existing = document.getElementById('tempMessage');
            if (existing) existing.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = 'tempMessage';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 500;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // Show loading overlay when navigating
        function showLoading(pageName) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.innerHTML = `
                <div>
                    <div>üöÄ ƒêang chuy·ªÉn ƒë·∫øn ${pageName}...</div>
                    <div style="font-size: 14px; margin-top: 10px;">Vui l√≤ng ch·ªù trong gi√¢y l√°t</div>
                </div>
            `;
            overlay.style.display = 'flex';
        }
        
        // Update current URL display
        function updateCurrentUrl() {
            const deployUrl = getDeploymentUrl();
            const currentUrlDiv = document.getElementById('currentUrl');
            
            if (deployUrl) {
                currentUrlDiv.textContent = deployUrl;
                currentUrlDiv.style.color = '#28a745';
            } else {
                currentUrlDiv.innerHTML = `
                    <span style="color: #dc3545;">Ch∆∞a c·∫•u h√¨nh URL deployment</span><br>
                    <span style="font-size: 0.8em;">Current: ${window.location.href}</span>
                `;
            }
        }
        
        // Add keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.altKey && !e.ctrlKey && !e.shiftKey) {
                    const num = parseInt(e.key);
                    if (num >= 1 && num <= menuItems.length) {
                        e.preventDefault();
                        const item = menuItems[num - 1];
                        const baseUrl = getDeploymentUrl();
                        if (baseUrl) {
                            const directUrl = `${baseUrl}?page=${item.page}`;
                            showLoading(item.title);
                            window.location.href = directUrl;
                        }
                    }
                }
            });
        }
        
        // Add tooltips for keyboard shortcuts
        function addKeyboardTooltips() {
            const menuCards = document.querySelectorAll('.menu-card');
            menuCards.forEach((card, index) => {
                card.title = `Click ho·∫∑c nh·∫•n Alt+${index + 1} ƒë·ªÉ m·ªü`;
            });
        }
        
        // Performance monitoring
        function logNavigationPerformance() {
            const deployUrl = getDeploymentUrl();
            console.log('üöÄ Performance Info:');
            console.log('Deployment URL:', deployUrl || 'Not configured');
            console.log('Current URL:', window.location.href);
            console.log('Direct Navigation:', deployUrl ? 'Enabled' : 'Needs setup');
            console.log('Menu Items:', menuItems.length);
        }
        
        // Initialize page
        function initializePage() {
            // Hide loading overlay
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 500);
            
            // Generate menu with direct URLs
            generateMenu();
            
            // Update current URL display
            updateCurrentUrl();
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Add tooltips
            setTimeout(addKeyboardTooltips, 100);
            
            // Performance logging
            logNavigationPerformance();
            
            console.log('‚úÖ Home page initialized');
            
            // Show helpful tip if first time
            if (!getStoredDeploymentUrl() && !getDeploymentUrl()) {
                setTimeout(() => {
                    showTemporaryMessage('üí° Tip: C·∫ßn c·∫•u h√¨nh Deployment URL ƒë·ªÉ navigation ho·∫°t ƒë·ªông t·ªëi ∆∞u');
                }, 2000);
            }
        }
        
        // Run when page loads
        window.onload = initializePage;
        
        // Handle back button and URL changes
        window.addEventListener('popstate', function(e) {
            updateCurrentUrl();
        });
        
        // Add some visual feedback for direct navigation
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulseGlow {
                    0% { box-shadow: 0 4px 20px rgba(102,126,234,0.3); }
                    50% { box-shadow: 0 8px 30px rgba(102,126,234,0.5); }
                    100% { box-shadow: 0 4px 20px rgba(102,126,234,0.3); }
                }
                
                .menu-card:hover {
                    animation: pulseGlow 2s infinite;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>